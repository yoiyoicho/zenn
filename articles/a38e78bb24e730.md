---
title: "AWS特化のCTFが超楽しかった！【writeup】"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CTF", "AWS"]
published: false
---

GitHub連携テスト

先日、AWSのセキュリティに関するコミュニティ「Security-JAWS」にて、AWS環境に特化したCTFが開催されました。

https://s-jaws.doorkeeper.jp/events/155025

これが超超超楽しくて、学びにもなったとてもいいイベントだったので、少し時間が経ってしまいましたが、writeup兼ふりかえり記を残します。

ちなみに私はCTF初挑戦でAWSも入門書を1周したくらいの知識しかありません。しかし問題の構成がよく練られていたので、私のような初心者でも時間いっぱいじっくりと楽しむことができました。

CTFの環境構築に作問に、と、これを準備するのは相当大変だったと思うのですが・・・運営の方々には本当に感謝です！

問題はTrivia、Warmup、Easy、Medium、Hardの5ランクに分かれていて、私はTrivia、Warmup、Easyランクの問題に挑戦しました。

TriviaはAWSの知識を問うクイズのような形式で、調べたらわかるものだったので、ここではWarmup、Easyの問題で印象に残ったものをまとめます！

## 事前準備

- M2 Macbook Air
- AWS CLIのインストール
    - Homebrew経由でインストールしました。
    https://zenn.dev/akakuro/articles/30f570b8863bef

## AWS CLI practice【Warmup】

指示：このIAMユーザーが所属するAWSアカウントIDは何？
与えられたデータ：IAMユーザーのアクセスキーIDとシークレットアクセスキー
※アカウントのリージョンは全問題共通で事前に知らされています。

:::details IAMユーザーとは？
AWSアカウントで利用している各種サービスにアクセスできるユーザー。ユーザーやグループごとに権限をカスタマイズできる。
:::

AWS CLIの`aws configure`コマンドでアクセスキーID、シークレットアクセスキー、リージョンを設定し、`aws sts get-celler-identity`コマンドでユーザーの識別情報を取得、という流れでアカウントIDがわかりました。

```
$ aws configure
AWS Access Key ID [None]: [アクセスキーID]
AWS Secret Access Key [None]: [シークレットアクセスキー]
Default region name [None]: us-east-1
Default output format [None]: json
```

```
$ aws sts get-celler-identity
{
    "UserId": "AIDA5YYUV3PDXROBLRDKF",
    "Account": "946546793415", #これがアカウントID
    "Arn": "arn:aws:iam::946546793415:user/ctf_challenge_0"
}
```

なお、このあとは問題ごとにIAMユーザーを切り替えてAWS CLIを操作するようになっていました。

私は都度上書きしていたのですが、`--profile`オプションを使えばプロファイルに名前をつけて保存することができたようです。

https://dev.classmethod.jp/articles/lim-cli-profile/

## Run Function【Warmup】

指示：アクセスキーを調べてFLAGを入手せよ！
与えられたデータ：IAMユーザーのアクセスキーIDとシークレットアクセスキー

とりあえず`aws config

## Find data2【Warmup】

指示：
与えられたデータ：

## Show IAM Policy【Warmup】

指示：このユーザーにアタッチされているポリシーを確認してみよう！Policyドキュメントを注意深くみたらFLAGが隠れているかも。
与えられたデータ：IAMユーザーのアクセスキーIDとシークレットアクセスキー

:::details IAMポリシーとは？
誰がどの条件でどのAWSリソースにアクセスできるか、という設定のこと。大きく分けて「アタッチドポリシー（管理ポリシー）」と「インラインポリシー」の2種類がある。

アタッチドポリシー（管理ポリシー）：ポリシーが単体として存在でき、複数のIAMユーザー、グループ、ロールにアタッチできる。
インラインポリシー：特定のIAMユーザー、グループ、ロールに直接埋め込まれる。
:::

まず、`aws configure`でIAMユーザーを登録します。

次にユーザーにアタッチされているポリシーを調べます。ユーザーのポリシーを調べるためにはユーザー名が必要なので、先にユーザー名を調べます。

模範解答は`aws sts get-celler-identity`で調べることですが・・・。

```
$ aws sts get-celler-identity
{
    "UserId": [略],
    "Account": [略],
    "Arn": "arn:aws:iam::[略]:user/ctf_challenge_5"  #user/のあとの文字列がユーザー名
}
```

問題を解いているときは`Arn`にユーザー名が含まれていることを知らなかったので、IAMユーザーの一覧を取得する`aws iam list-users`を打って、権限がないことによって出力されたエラー文からユーザー名を知るという変則的な方法でユーザー名を取得しました・・・。

ユーザー名がわかったので、ユーザーにアタッチされている管理ポリシーを`aws iam list-attached-user-policies`コマンドで調べます。

```
$ aws iam list-attached-user-policies --user-name ctf_challenge_5
{
    "AttachedPolicies": []
}
```

あれっポリシーがない！？

ここでポリシーには管理ポリシーとインラインポリシーの2種類があることに気づき、インラインポリシーを`aws iam list-user-policies`コマンドで調べます。

```
$ aws iam list-user-policies --user-name ctf_challenge_5
{
    "PolicyNames": []
}
```

これもない！　なんで〜？

ここでChatGPTに聞いて、このユーザーが属しているIAMグループにポリシーがアタッチされている可能性に気づきました。そこで、このユーザーが所属しているIAMグループ名を`aws iam list-groups-for-user`コマンドで調べます。

```
$ aws iam list-groups-for-user --user-name ctf_challenge_5
{
    "Groups": [
        {
            "Path": "/",
            "GroupName": "ctf5",
            "GroupId": "AGPAQZ2IU22WHDOHFQVUC",
            "Arn": "arn:aws:iam::055450064556:group/ctf5",
            "CreateDate": "2023-08-06T14:48:22+00:00"
        }
    ]
}
```

`ctf5`というグループに所属していることがわかりました。

グループ名がわかれば、グループにアタッチされているポリシーを調べることができます。まずは管理ポリシーから。

```
aws iam list-attached-group-policies --group-name ctf5
{
    "AttachedPolicies": []
}
```

またない・・・。インラインポリシーを確認します。

```
aws iam list-group-policies --group-name ctf5
{
    "PolicyNames": [
        "selfcheck"
    ]
}
```

ようやく実のある答えが返ってきました！

`aws iam get-group-policy`でポリシーの内容を取得します。

```
$ aws iam get-group-policy --group-name ctf5 --policy-name selfcheck
{
    "GroupName": "ctf5",
    "PolicyName": "selfcheck",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": {
            "Sid": "U0pBV1N7RG9feW91LWZpbmRfdGhlX0B0dGFjaGVkX3AwbDFjeT99",
            "Effect": "Allow",
            "Action": [
                "iam:Get*",
                "iam:List*"
            ],
            "Resource": [
                "arn:aws:iam::055450064556:group/ctf5",
                "arn:aws:iam::055450064556:user/ctf_challenge_5"
            ]
        }
    }
}
```

さて、ここからどうすればよいのでしょうか。「Policyドキュメントを注意深くみる」とは・・・？

えぇい、GPTに丸投げだぁっ！

base64

:::details Sidとは？
ステートメポリシードキュメントに与える任意の識別子
:::
