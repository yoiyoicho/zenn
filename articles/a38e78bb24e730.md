---
title: "AWS特化のCTFが超楽しかった！【writeup】"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CTF", "AWS"]
published: false
---

先日、AWSのセキュリティに関するコミュニティ「Security-JAWS」にて、AWS環境に特化したCTFが開催されました。

https://s-jaws.doorkeeper.jp/events/155025

これが超超超楽しくて、学びにもなったとてもいいイベントだったので、少し時間が経ってしまいましたが、writeup兼ふりかえり記を残します。

ちなみに私はCTF初挑戦でAWSも入門書を1周したくらいの知識しかありません。しかし問題の構成がよく練られていたので、私のような初心者でも時間いっぱいじっくりと楽しむことができました。

CTFの環境構築に作問に、と、これを準備するのは相当大変だったと思うのですが・・・運営の方々には本当に感謝です！

問題はTrivia、Warmup、Easy、Medium、Hardの5ランクに分かれていて、私はTrivia、Warmup、Easyランクの問題に挑戦しました。

TriviaはAWSの知識を問うクイズのような形式で、調べたらわかるものだったので、ここではWarmup、Easyの問題で印象に残ったものをまとめます！

## 事前準備

- M2 Macbook Air
- AWS CLIのインストール
    - Homebrew経由でインストールしました。
    https://zenn.dev/akakuro/articles/30f570b8863bef

## Warmup

### AWS CLI practice

指示：このIAMユーザーが所属するAWSアカウントIDは何？
与えられたデータ：IAMユーザーのアクセスキーIDとシークレットアクセスキー
※アカウントのリージョンは全問題共通で事前に知らされています。

:::details IAMユーザーとは？
AWSアカウントで利用している各種サービスにアクセスできるユーザー。ユーザーやグループごとに権限をカスタマイズできる。
:::

AWS CLIの`aws configure`コマンドでアクセスキーID、シークレットアクセスキー、リージョンを設定し、`aws sts get-celler-identity`コマンドでユーザーの識別情報を取得、という流れでアカウントIDがわかりました。

```
$ aws configure
AWS Access Key ID [None]: [アクセスキーID]
AWS Secret Access Key [None]: [シークレットアクセスキー]
Default region name [None]: us-east-1
Default output format [None]: json
```

```
$ aws sts get-celler-identity
{
    "UserId": "AIDA5YYUV3PDXROBLRDKF",
    "Account": "946546793415", #これがアカウントID
    "Arn": "arn:aws:iam::946546793415:user/ctf_challenge_0"
}
```

なお、このあとは問題ごとにIAMユーザーを切り替えてAWS CLIを操作するようになっていました。

私は都度上書きしていたのですが、`--profile`オプションを使えばプロファイルに名前をつけて保存することができたようです。

https://dev.classmethod.jp/articles/lim-cli-profile/

### Find data2

指示：FLAGはバケツに突っ込んであるので探してね！
与えられたデータ：IAMユーザーのアクセスキーIDとシークレットアクセスキー

### Show IAM Policy

指示：このユーザーにアタッチされているポリシーを確認してみよう！Policyドキュメントを注意深くみたらFLAGが隠れているかも。
与えられたデータ：IAMユーザーのアクセスキーIDとシークレットアクセスキー

:::details IAMポリシーとは？
誰がどの条件でどのAWSリソースにアクセスできるか、という設定のこと。大きく分けて「アタッチドポリシー（管理ポリシー）」と「インラインポリシー」の2種類がある。

アタッチドポリシー（管理ポリシー）：ポリシーが単体として存在でき、複数のIAMユーザー、グループ、ロールにアタッチできる。
インラインポリシー：特定のIAMユーザー、グループ、ロールに直接埋め込まれる。
:::

まず、`aws configure`で、AWS CLIにIAMユーザーを登録します。

次にユーザーにアタッチされているポリシーを調べます。ユーザーのポリシーを調べるためにはユーザー名が必要なので、先にユーザー名を調べます。

模範解答は`aws sts get-celler-identity`で調べることですが・・・。

```
$ aws sts get-celler-identity
{
    "UserId": [略],
    "Account": [略],
    "Arn": "arn:aws:iam::[略]:user/ctf_challenge_5"  #user/のあとの文字列がユーザー名
}
```

問題を解いているときは`Arn`にユーザー名が含まれていることを知らなかったので、IAMユーザーの一覧を取得する`aws iam list-users`を打って、権限がないことによって出力されたエラー文からユーザー名を知るという変則的な方法でユーザー名を取得しました・・・。

ユーザー名がわかったので、ユーザーにアタッチされている管理ポリシーを`aws iam list-attached-user-policies`コマンドで調べます。

```
$ aws iam list-attached-user-policies --user-name ctf_challenge_5
{
    "AttachedPolicies": []
}
```

あれっポリシーがない！？

ここでポリシーには管理ポリシーとインラインポリシーの2種類があることに気づき、インラインポリシーを`aws iam list-user-policies`コマンドで調べます。

```
$ aws iam list-user-policies --user-name ctf_challenge_5
{
    "PolicyNames": []
}
```

これもない！　なんで〜？

ここでChatGPTに聞いて、このユーザーが属しているIAMグループにポリシーがアタッチされている可能性に気づきました。そこで、このユーザーが所属しているIAMグループ名を`aws iam list-groups-for-user`コマンドで調べます。

```
$ aws iam list-groups-for-user --user-name ctf_challenge_5
{
    "Groups": [
        {
            "Path": "/",
            "GroupName": "ctf5",
            "GroupId": "AGPAQZ2IU22WHDOHFQVUC",
            "Arn": "arn:aws:iam::055450064556:group/ctf5",
            "CreateDate": "2023-08-06T14:48:22+00:00"
        }
    ]
}
```

`ctf5`というグループに所属していることがわかりました。

グループ名がわかれば、グループにアタッチされているポリシーを調べることができます。まずは管理ポリシーから。

```
aws iam list-attached-group-policies --group-name ctf5
{
    "AttachedPolicies": []
}
```

またない・・・。インラインポリシーを確認します。

```
aws iam list-group-policies --group-name ctf5
{
    "PolicyNames": [
        "selfcheck"
    ]
}
```

ようやく実のある答えが返ってきました！

`aws iam get-group-policy`でポリシーの内容を取得します。

```
$ aws iam get-group-policy --group-name ctf5 --policy-name selfcheck
{
    "GroupName": "ctf5",
    "PolicyName": "selfcheck",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": {
            "Sid": "U0pBV1N7RG9feW91LWZpbmRfdGhlX0B0dGFjaGVkX3AwbDFjeT99",
            "Effect": "Allow",
            "Action": [
                "iam:Get*",
                "iam:List*"
            ],
            "Resource": [
                "arn:aws:iam::055450064556:group/ctf5",
                "arn:aws:iam::055450064556:user/ctf_challenge_5"
            ]
        }
    }
}
```

さて、ここからどうすればよいのでしょうか。「Policyドキュメントを注意深くみる」とは・・・？

えぇい、GPTに丸投げだぁっ！

> User
SJAWS{xxxxx}という形式のFLAGを探しているのですが、このポリシードキュメントにヒントはありそうでしょうか？

> ChatGPT
このポリシードキュメントには、特定の形式（SJAWS{xxxxx}）のFLAGに関する明確なヒントは含まれていないようです。ただし、ステートメントID（Sid）には次のような長い文字列があります：
U0pBV1N7RG9feW91LWZpbmRfdGhlX0B0dGFjaGVkX3AwbDFjeT99
この文字列はBase64エンコードされている可能性があり、デコードすると何らかのヒントやFLAGが現れるかもしれません。Base64デコードを試してみる価値があります。

base64！！！そういうことか〜〜〜！

SidはAWS側が機械的に割り振るものなのかなと思っていたので、ここがFLAGになっているとは気付きませんでした。

:::details Sidとは？
ポリシードキュメントに与える任意の識別子。ポリシーの説明文として使うことができる。
:::

この解読方法に辿り着いた瞬間が、今回のCTFで脳汁最大噴射の瞬間だったかもしれません。GPT、ありがとう。

オンラインのbase64デコードツールを使って、無事FLAGを入手できました。

### Run Function

指示：アクセスキーを調べてFLAGを入手せよ！
与えられたデータ：IAMユーザーのアクセスキーIDとシークレットアクセスキー

アクセスキーを調べろということなので、とりあえず`aws configure`で、AWS CLIにIAMユーザーを登録します。

さて、このあとなにをすればいいのか・・・。GPTに聞いてあたりをつけます。

> User
CTFを解いています。AWSのアクセスキーIDとシークレットアクセスキーが与えられています。アクセスキーを調べてFLAGを入手する方法を教えてください。問題のタイトルは「Run Function」です。

> ChatGPT
CTF（Capture The Flag）のコンテキストでAWSのアクセスキーIDとシークレットアクセスキーが与えられている場合、問題のタイトル「Run Function」から推測すると、AWS Lambda関数を実行してFLAGを取得する必要があるかもしれません。

なるほど！ 問題文からしても、IAMユーザーに紐づけられているLambdaの関数を実行するとFLAGが入手できそうです。

:::details AWS Lambdaとは？
あああ
:::

:::details Lambda関数とは？
あああ
:::

Lambda関数の一覧を取得するコマンド`aws lambda list-functions`を実行するとパーミッションエラーが出ました。

```
$ aws lambda list-functions

An error occurred (AccessDeniedException) when calling the ListFunctions operation: User: arn:aws:iam::055450064556:user/ctf_challenge_6 is not authorized to perform: lambda:ListFunctions on resource: * because no identity-based policy allows the lambda:ListFunctions action
```

IAMユーザーのポリシーを確認して、紐づけられているLambda関数がないか確認します。

```
$ aws iam list-user-policies --user-name ctf_challenge_6
{
    "PolicyNames": [
        "runlambda"
    ]
}
```

lambda関数に関連ありそうなインラインポリシーが設定されていました！

ポリシーの詳細を確認します。

```
$ aws iam get-user-policy --user-name ctf_challenge_6 --policy-name runlambda
{
    "UserName": "ctf_challenge_6",
    "PolicyName": "runlambda",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Sid": "readiam",
                "Effect": "Allow",
                "Action": [
                    "iam:Get*",
                    "iam:List*"
                ],
                "Resource": "arn:aws:iam::055450064556:user/ctf_challenge_6"
            },
            {
                "Sid": "lambdaInvoke",
                "Effect": "Allow",
                "Action": [
                    "lambda:InvokeFunction"
                ],
                "Resource": "arn:aws:lambda:ap-northeast-1:055450064556:function:run_me"
            }
        ]
    }
}
```

ポリシーを読み解いて、このIAMユーザーには `run_me`という名前のLambda関数を実行する権限があることがわかりました。

IAMユーザーとLambdaのリージョンの違いに注意して、Lambda関数を実行します。

```
$ aws lambda invoke --function-name run_me --region ap-northeast-1 output.txt
{
    "StatusCode": 200,
    "ExecutedVersion": "$LATEST"
}
```

実行結果を保存した`output.txt`には、`{"statusCode": 200, "body": "\"Look at the log!\""}`とありました。

Lambdaのログを見ればFLAGがありそう・・・というところまで辿り着けたのですが、AWS CLI経由でLambdaの実行ログを取得する方法がわからず、あえなくギブアップとなりました。

正解は、上記のlambda関数の実行コマンドに`--log-type Tail`というオプションをつけることでした。問題としてはさらにここからbase64をデコードするステップも入っていたようです。

## Easy

### Recon the website

指示：Webサイトを調査してFLAGを入手せよ！
与えられたデータ：WebアプリケーションのURL

ざっくりした指示ゆえにあたりをつけづらく、解くのを半ば諦めていたのですが、CTFの後半で運営の方がヒントを出してくれました。

> 「Recon the website」の問題も思ったよりも正答率が悪いのでヒントをだします！
この問題のヒントはこのサイトのHTMLソースにも書かれていますが、このWebサイトはあるAWSサービスを利用して作成されています。
こういった静的なWebサイトの公開によく利用されるサービスです。
このAWSサービスは残念なことに設定をミスっているので、それを利用すればFLAGを獲得できるかもしれません。

静的なWebサイトのホスティングによく使われるのはS3です。S3の設定ミスによって、本来見られるはずのないファイルが外部から見られるようになっていて、そこにFLAGがあるのだろうと予測しました。

GPTに聞いたところ、どうやら「バケット名」がわかっている＆パブリックアクセスが許可されているという状態であれば、外部からファイルにアクセスできそうです。

> 通常、S3バケットの名前はURLの一部として公開されています。この名前を特定できれば、バケットに対するさまざまな操作が可能になります。
S3バケットがパブリックアクセスを許可している場合、その中のファイルも一般に公開されている可能性があります。
例: http://[バケット名].s3.amazonaws.com/[ファイル名]

さらに「AWS S3 バケット名 CTF」でググるとこちらの記事がヒット。

https://mot-skmt.hateblo.jp/entry/flaws-cloud-lv1

バケット名はドメイン名と同じになるのですね。またリージョン名のほうは事前に教えられています。

ブラウザから`http://[バケット名＝ドメイン名].s3.[リージョン名].amazonaws.com`にアクセスしたところ、期待通りS3のファイル一覧が表示され、FLAGを入手できました！

終了後の解説では、「現実世界でも度々問題になっている、S3バケットの設定不備によって情報が漏洩してしまうケースをモチーフにした問題」と説明があり、確かにこんなに簡単にアクセスできてしまうのかと実感できました。

### Get Provision

指示：EC2 上で動く Web アプリケーションからインスタンスのプロビジョニングのデータを入手せよ！
与えられたデータ：WebアプリケーションのURL

まずはプロビジョニングについてググります。

:::details プロビジョニングとは？
あああ
:::