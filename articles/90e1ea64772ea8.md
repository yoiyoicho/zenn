---
title: "Docker + Rails7.1 ã®ç’°å¢ƒæ§‹ç¯‰ã§è©°ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆ"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["RubyonRails", "Docker"]
published: true
---

Docker + Rails + PostgreSQLã¨ã„ã†ã‚ˆãã‚ã‚‹æ§‹æˆã§ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ãŸã¨ã“ã‚ã€Rails7.1ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸæ–°æ©Ÿèƒ½ã«ã‚ˆã£ã¦è©°ã¾ã£ãŸç‚¹ãŒã‚ã£ãŸã®ã§ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

## å®Ÿè¡Œç’°å¢ƒ

- M2 Macbook Air
- Rails 7.1.2
- Ruby 3.2.2
- PostgreSQL 16.1 
- Docker 20.10.21

## å•é¡Œã®å†ç¾

Docker docsã«æ²è¼‰ã•ã‚Œã¦ã„ãŸã“ã¡ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚‚ã¨ã«ç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚

https://github.com/docker/awesome-compose/tree/master/official-documentation-samples/rails/

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®šç¾©

`Dockerfile`ã‚’ä½œæˆã€‚Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ç¾æ™‚ç‚¹ã§ã®æœ€æ–°å®‰å®šç‰ˆ3.2.2ã«ã—ã¾ã™ã€‚

```docker:Dockerfile
# syntax=docker/dockerfile:1
FROM ruby:3.2.2
RUN apt-get update -qq && apt-get install -y nodejs postgresql-client
WORKDIR /myapp
COPY Gemfile /myapp/Gemfile
COPY Gemfile.lock /myapp/Gemfile.lock
RUN bundle install

# Add a script to be executed every time the container starts.
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 3000

# Configure the main process to run when running the image
CMD ["rails", "server", "-b", "0.0.0.0"]
```

`Gemfile`ã®ä½œæˆã€‚Railsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æŒ‡å®šã›ãšæœ€æ–°å®‰å®šç‰ˆã‚’å–å¾—ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã«ã—ã¾ã™ã€‚â€»ã‚ã¨ã§`Gemfile`ã‚’ç¢ºèªã™ã‚‹ã¨7.1.2ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

```:Gemfile
source 'https://rubygems.org'
gem 'rails'
```

ç©ºã®`Gemfile.lock`ã‚’ä½œæˆã€‚

```Shell
$ touch Gemfile.lock
```

`entrypoint.sh`ã‚‚ä½œæˆã—ã¾ã™ã€‚

```Shell:entrypoint.sh
#!/bin/bash
set -e

# Remove a potentially pre-existing server.pid for Rails.
rm -f /myapp/tmp/pids/server.pid

# Then exec the container's main process (what's set as CMD in the Dockerfile).
exec "$@"
```

`compose.yaml`ã®ä½œæˆã€‚ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯`docker-compose.yml`ã§ã™ãŒã€[Dockerã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.jp/compose/compose-file/index.html)ã§ã¯`compose.yaml`ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã‚Œã«ãªã‚‰ã„ã¾ã™ã€‚

ã¾ãŸã€DBã®ãƒ‡ãƒ¼ã‚¿ã‚’Dockerã®ç®¡ç†ä¸‹ã«ãŠããŸã‹ã£ãŸã®ã§ã€ãƒã‚¦ãƒ³ãƒˆã®æ–¹æ³•ã‚’ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

```yaml:compose.yaml
services:
  db:
    image: postgres
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - .:/myapp
    ports:
      - "3000:3000"
    depends_on:
      - db
volumes:
  db-data:
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰

`docker compose run`ã‚³ãƒãƒ³ãƒ‰ã§Railsã‚¢ãƒ—ãƒªã®é››å½¢ã‚’ä½œæˆã—ã¾ã™ã€‚Railsã¯APIãƒ¢ãƒ¼ãƒ‰ã§ä½¿ã„ãŸã‹ã£ãŸã®ã§ã€æœ«å°¾ã«`--api`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```shell
$ docker compose run --no-deps web rails new . --force --database=postgresql --api
```

`Gemfile`ãŒæ›´æ–°ã•ã‚ŒãŸã®ã§ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ã³ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```shell
$ docker compose build
```
ã“ã“ã¾ã§ã¯å•é¡Œãªãé€²ã‚“ã ã‚ˆã†ã«è¦‹ãˆãŸã®ã§ã™ãŒâ€¦â€¦ã€‚

### DBã¨ã®æ¥ç¶š

`config/database.yml`ã«PostgreSQLã¨ã®æ¥ç¶šæƒ…å ±ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff yml:config/database.yml
default: &default
  adapter: postgresql
  encoding: unicode
+   host: db
+   username: postgres
+   password: password
  # For details on connection pooling, see Rails configuration guide
  # https://guides.rubyonrails.org/configuring.html#database-pooling
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

# ä»¥ä¸‹ç•¥
```

`docker compose up`ã§PostgreSQLã¨Railsã‚’èµ·å‹•ã—ã¾ã™ã€‚

```shell
$ docker compose up
```

åˆ¥ã®ã‚·ã‚§ãƒ«ã«ç§»ã£ã¦DBã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ãŸã¨ã“ã‚â€¦â€¦ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼

```shell
$ docker compose run web bundle exec rake db:create

[+] Running 1/0
 â ¿ Container db-1  Running                                                                                        0.0s
connection to server at "192.168.160.2", port 5432 failed: fe_sendauth: no password supplied
Couldn't create 'myapp_production' database. Please check your configuration.
rake aborted!
ActiveRecord::ConnectionNotEstablished: connection to server at "192.168.160.2", port 5432 failed: fe_sendauth: no password supplied (ActiveRecord::ConnectionNotEstablished)
```

## ã‚¨ãƒ©ãƒ¼ã®åŸå› 

ã‚¨ãƒ©ãƒ¼æ–‡ã‚’ã‚ˆãè¦‹ã‚‹ã¨ã€ãªãœã‹productionç”¨ã®DBã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚`config/database.yml`ã«ã¯ã¾ã productionç”¨ã®è¨­å®šã‚’æ›¸ã„ã¦ã„ãªã„ã®ã§æ¥ç¶šã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã¯å½“ç„¶ã§ã™ã€‚

ã¾ãŸã€`docker compose up`ã‚’å®Ÿè¡Œä¸­ã®ã‚·ã‚§ãƒ«ã«æˆ»ã£ã¦Railsã®ãƒ­ã‚°ã‚’ã‚ˆãè¦‹ã‚‹ã¨ã€ã“ã¡ã‚‰ã‚‚productionç’°å¢ƒã§èµ·å‹•ã—ã¦ã„ã¾ã—ãŸã€‚

```shell
web-1  | => Booting Puma
web-1  | => Rails 7.1.2 application starting in production
web-1  | => Run `bin/rails server --help` for more startup options
```

ç’°å¢ƒå¤‰æ•°ã§`RAILS_ENV`ã‚’æŒ‡å®šã—ã¦ã„ãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç’°å¢ƒã¯developmentç’°å¢ƒã«ãªã‚‹ã¯ãšãªã®ã§ã€ãªãœã“ã†ãªã£ã¦ã„ã‚‹ã®ã‹è¬ãŒæ·±ã¾ã‚Šã¾ã™â€¦â€¦ã€‚

ï¼ï¼ï¼

ãã‚“ãªã“ã‚“ãªã§è‰²ã€…èª¿ã¹ãŸçµæœã€åŸå› ã¯Rails7.1ã®æ–°æ©Ÿèƒ½ã€ŒDockerfileã®è‡ªå‹•ç”Ÿæˆã€ã«ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼

https://railsguides.jp/7_1_release_notes.html

> æ–°è¦Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§DockerãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼ˆ#46762ï¼‰ã€‚ æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«Dockeré–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã¾ã‚Œã¾ã™ã€‚
> ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Dockerã§productionç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã—ã¦æä¾›ã•ã‚Œã¾ã™ã€‚é‡è¦ãªã®ã¯ã€ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é–‹ç™ºç”¨ã§ã¯ãªã„ã“ã¨ã§ã™ã€‚

`Dockerfile`ã‚’ç¢ºèªã™ã‚‹ã¨ã€å…¨ãè¦šãˆã®ãªã„å†…å®¹ãŒï¼ã€€`rails new`ã—ãŸã¨ãã«ãƒãƒƒãƒãƒªä¸Šæ›¸ãã•ã‚Œã¦ã„ãŸã‚ˆã†ã§ã™ã€‚`RAILS_ENV="production"`ã¨ã„ã†è¨˜è¿°ãŒã‚ã‚‹ã®ã§ã“ã‚Œã§ã¯productionç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

```docker:Dockerfile
# syntax = docker/dockerfile:1

# Make sure RUBY_VERSION matches the Ruby version in .ruby-version and Gemfile
ARG RUBY_VERSION=3.2.2
FROM registry.docker.com/library/ruby:$RUBY_VERSION-slim as base

# Rails app lives here
WORKDIR /rails

# Set production environment
ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT="development"


# Throw-away build stage to reduce size of final image
FROM base as build

# Install packages needed to build gems
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential git libpq-dev libvips pkg-config

# Install application gems
COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE_PATH}"/ruby/*/bundler/gems/*/.git && \
    bundle exec bootsnap precompile --gemfile

# Copy application code
COPY . .

# Precompile bootsnap code for faster boot times
RUN bundle exec bootsnap precompile app/ lib/


# Final stage for app image
FROM base

# Install packages needed for deployment
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl libvips postgresql-client && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Copy built artifacts: gems, application
COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /rails /rails

# Run and own only the runtime files as a non-root user for security
RUN useradd rails --create-home --shell /bin/bash && \
    chown -R rails:rails db log storage tmp
USER rails:rails

# Entrypoint prepares the database.
ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Start the server by default, this can be overwritten at runtime
EXPOSE 3000
CMD ["./bin/rails", "server"]
```

## å¯¾å¿œ

`Dockerfile`ã‚’å…ƒã®å†…å®¹ã§ä¸Šæ›¸ãã™ã‚Œã°ç›´ã‚Šãã†ã§ã™ãŒã€ã›ã£ã‹ãproductionç”¨ã®`Dockerfile`ãŒæ‰‹ã«å…¥ã£ãŸã®ã§ã€ä¸‹è¨˜ãƒªãƒ³ã‚¯å…ˆã‚’å‚è€ƒã«ã€`Dockerfile`ã¨`compose.yaml`ã‚’developmentç’°å¢ƒç”¨ã¨productionç’°å¢ƒç”¨ã«åˆ†ã‘ã¦ä½œã‚Šç›´ã™ã“ã¨ã«ã—ã¾ã—ãŸã€‚ãªãŠã“ã“ã§ã¯developmentç’°å¢ƒã®æ§‹ç¯‰ã®ã¿ã‚’ã‚´ãƒ¼ãƒ«ã¨ã—ã¾ã™ã€‚

https://abillyz.com/watanabe/studies/467

ã¾ãšã¯RailsãŒç”Ÿæˆã—ãŸproductionç’°å¢ƒç”¨ã®`Dockerfile`ã¯`Dockerfile.prod`ã¨ã—ã¦é€€é¿ã—ã¦ãŠãã¾ã™ã€‚ãã—ã¦ã€å…ƒã®`Dockerfile`ã®å†…å®¹ã‚’`Dockerfile.dev`ã¨ã—ã¦ä½œæˆã—ç›´ã—ã¾ã™ã€‚

```docker:Dockerfile.dev
# syntax=docker/dockerfile:1
FROM ruby:3.2.2
RUN apt-get update -qq && apt-get install -y nodejs postgresql-client
WORKDIR /myapp
COPY Gemfile /myapp/Gemfile
COPY Gemfile.lock /myapp/Gemfile.lock
RUN bundle install

# Add a script to be executed every time the container starts.
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 3000

# Configure the main process to run when running the image
CMD ["rails", "server", "-b", "0.0.0.0"]
```

```docker:Dockerfile.prod
# syntax = docker/dockerfile:1

# Make sure RUBY_VERSION matches the Ruby version in .ruby-version and Gemfile
ARG RUBY_VERSION=3.2.2
FROM registry.docker.com/library/ruby:$RUBY_VERSION-slim as base

# ä»¥ä¸‹ç•¥
```

`compose.yaml`ã‚’`compose-dev.yaml`ã«æ”¹åã—ã€`web`ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ“ãƒ«ãƒ‰ã«ä½¿ã†`Dockerfile`ã‚’`Dockerfile.dev`ã«æŒ‡å®šã—ã¾ã™ã€‚

```diff yml:compose-dev.yaml
services:
  db:
    image: postgres
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password
  web:
    build:
+       context: .
+       dockerfile: Dockerfile.dev
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - .:/myapp
    ports:
      - "3000:3000"
    depends_on:
      - db
volumes:
  db-data:
```

`compose-dev.yaml`ã‚’ã‚‚ã¨ã«ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚`-f`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã¾ã™ã€‚

```shell
$ docker compose -f compose-dev.yaml build
```

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

```shell
$ docker compose -f compose-dev.yaml up
```

PostgreSQLã¨RailsãŒèµ·å‹•ã—ã€Railsã¯developmentç’°å¢ƒã§èµ·å‹•ã—ã¾ã—ãŸï¼

```shell
web-1  | => Booting Puma
web-1  | => Rails 7.1.2 application starting in development
web-1  | => Run `bin/rails server --help` for more startup options
web-1  | Puma starting in single mode...
web-1  | * Puma version: 6.4.0 (ruby 3.2.2-p53) ("The Eagle of Durango")
web-1  | *  Min threads: 5
web-1  | *  Max threads: 5
web-1  | *  Environment: development
web-1  | *          PID: 1
web-1  | * Listening on http://0.0.0.0:3000
web-1  | Use Ctrl-C to stop
```

DBä½œæˆã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¡ã¾ã™ã€‚

```shell
$ docker compose -f compose-dev.yaml run web rake db:create

[+] Running 1/0
 â ¿ Container db-1  Running                                                                                                                       0.0s
Created database 'myapp_development'
Created database 'myapp_test'
```

ç„¡äº‹developmentã¨testã®2ã¤ã®DBãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼

ã¾ã•ã‹`Dockerfile`ãŒä¸Šæ›¸ãã•ã‚Œã¦ã„ã‚‹ã¨ã¯æ€ã‚ãªã„ã®ã§ã€äºˆæƒ³å¤–ã®è½ã¨ã—ç©´ã§ã—ãŸã€‚
